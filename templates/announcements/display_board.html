{% extends 'base.html' %}

{% block title %}Display Board - RailAnnounce{% endblock %}

{% block extra_css %}
<style>
    .display-board-container {
        background: #000;
        color: #fff;
        min-height: 100vh;
        padding: 30px;
        font-family: 'Courier New', monospace;
    }
    .board-header {
        text-align: center;
        padding: 20px;
        border-bottom: 2px solid #fff;
        margin-bottom: 30px;
    }
    .board-header h1 {
        color: #0d6efd;
        font-size: 2.5rem;
        margin: 0;
    }
    .announcement-item {
        padding: 20px;
        margin-bottom: 20px;
        border-left: 4px solid #0d6efd;
        background: #1a1a1a;
        border-radius: 5px;
    }
    .announcement-text {
        font-size: 1.2rem;
        margin-bottom: 15px;
        line-height: 1.6;
    }
    .language-tabs {
        margin-top: 15px;
    }
    .language-tab {
        display: inline-block;
        padding: 5px 15px;
        margin: 5px;
        background: #333;
        border: 1px solid #555;
        cursor: pointer;
        border-radius: 3px;
    }
    .language-tab.active {
        background: #0d6efd;
        border-color: #0d6efd;
    }
    .audio-controls {
        margin-top: 10px;
    }
    .status-indicator {
        display: inline-block;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-right: 5px;
    }
    .status-indicator.online {
        background: #28a745;
        animation: blink 2s infinite;
    }
    @keyframes blink {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }
</style>
{% endblock %}

{% block content %}
<div class="display-board-container" id="display-board">
    <div class="board-header">
        <h1><i class="bi bi-display"></i> RAILANNOUNCE DISPLAY BOARD</h1>
        <p>
            <span class="status-indicator online" id="connection-status"></span>
            <span id="connection-text">Connected</span>
        </p>
        <p class="text-muted">{{ board.name }} - {{ board.location|default:"Main Station" }}</p>
    </div>
    
    <div id="announcements-container">
        {% for announcement in announcements %}
            <div class="announcement-item" data-announcement-id="{{ announcement.id }}">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="badge bg-{% if announcement.status == 'completed' %}success{% elif announcement.status == 'processing' %}warning{% else %}secondary{% endif %}">
                        {{ announcement.get_status_display }}
                    </span>
                    <small class="text-muted">Priority: {{ announcement.priority }}</small>
                </div>
                
                <div class="announcement-text" data-language="original">
                    {{ announcement.text }}
                </div>
                
                {% if announcement.translations.all %}
                    <div class="language-tabs">
                        <span class="language-tab active" data-lang="original">Original ({{ announcement.detected_language|upper }})</span>
                        {% for translation in announcement.translations.all %}
                            <span class="language-tab" data-lang="{{ translation.language_code }}">
                                {{ translation.language_code|upper }}
                            </span>
                        {% endfor %}
                    </div>
                    
                    {% for translation in announcement.translations.all %}
                        <div class="announcement-text d-none" data-language="{{ translation.language_code }}">
                            {{ translation.translated_text }}
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="alert alert-info mt-2">
                        <small>Translations are being processed...</small>
                    </div>
                {% endif %}
                
                <div class="audio-controls">
                    {% for audio in announcement.audio_files.all %}
                        <audio id="audio-{{ announcement.id }}-{{ audio.language_code }}" class="d-none">
                            <source src="{{ audio.audio_file.url }}" type="audio/wav">
                        </audio>
                    {% endfor %}
                </div>
            </div>
        {% empty %}
            <div class="announcement-item">
                <div class="announcement-text text-center">
                    No announcements available at this time.
                </div>
            </div>
        {% endfor %}
    </div>
</div>

<script>
    // WebSocket connection
    const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsUrl = `${wsProtocol}//${window.location.host}/ws/display-board/`;
    const socket = new WebSocket(wsUrl);
    
    socket.onopen = function(e) {
        console.log('WebSocket connected');
        document.getElementById('connection-status').classList.add('online');
        document.getElementById('connection-text').textContent = 'Connected';
    };
    
    socket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        console.log('Received:', data);
        
        if (data.type === 'announcement_ready') {
            // Reload page to show new announcement
            location.reload();
        } else if (data.type === 'current_announcements') {
            // Update announcements (if needed)
            updateAnnouncements(data.announcements);
        }
    };
    
    socket.onerror = function(e) {
        console.error('WebSocket error:', e);
        document.getElementById('connection-status').classList.remove('online');
        document.getElementById('connection-text').textContent = 'Connection Error';
    };
    
    socket.onclose = function(e) {
        console.log('WebSocket closed');
        document.getElementById('connection-status').classList.remove('online');
        document.getElementById('connection-text').textContent = 'Disconnected';
        // Try to reconnect after 5 seconds
        setTimeout(function() {
            location.reload();
        }, 5000);
    };
    
    // Language tab switching
    document.querySelectorAll('.language-tab').forEach(tab => {
        tab.addEventListener('click', function() {
            const lang = this.dataset.lang;
            const item = this.closest('.announcement-item');
            
            // Update active tab
            item.querySelectorAll('.language-tab').forEach(t => t.classList.remove('active'));
            this.classList.add('active');
            
            // Show/hide text
            item.querySelectorAll('.announcement-text').forEach(text => {
                if (text.dataset.language === lang) {
                    text.classList.remove('d-none');
                } else {
                    text.classList.add('d-none');
                }
            });
        });
    });
    
    // Auto-refresh every 30 seconds
    setInterval(function() {
        socket.send(JSON.stringify({type: 'get_current'}));
    }, 30000);
</script>
{% endblock %}

